name: Refresh Playlists Nightly

on:
  schedule:
    # Run daily at 2 AM UTC (adjust timezone as needed)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  refresh-playlists:
    runs-on: ubuntu-latest
    
    steps:
    - name: Refresh All Playlists
      run: |
        echo "üîÑ Refreshing all playlists..."
        BASE_URL="${BASE_URL:-https://stablekraft.app}"
        
        # Step 1: Refresh playlist cache
        echo "üìã Step 1: Refreshing playlist cache..."
        REFRESH_RESPONSE=$(curl -s -w "\n%{http_code}" "${BASE_URL}/api/playlist-cache?refresh=all")
        HTTP_CODE=$(echo "$REFRESH_RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$REFRESH_RESPONSE" | sed '$d')
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "‚úÖ Playlist cache refreshed successfully"
          echo "$RESPONSE_BODY" | jq '.' || echo "$RESPONSE_BODY"
        else
          echo "‚ùå Failed to refresh playlist cache (HTTP $HTTP_CODE)"
          echo "$RESPONSE_BODY"
          exit 1
        fi
        
        # Wait a bit for cache to settle
        sleep 5
        
        # Step 2: Refresh playlists with full v4v parsing
        echo ""
        echo "üìã Step 2: Refreshing playlists with full RSS parsing (includes v4v payment data)..."

        # Refresh each main playlist to ensure all feeds are discovered and fully parsed
        PLAYLISTS=("hgh" "mmt" "sas" "mmm" "iam" "itdv" "b4ts" "upbeats")

        for PLAYLIST in "${PLAYLISTS[@]}"; do
          echo "  üîÑ Refreshing $PLAYLIST playlist..."
          curl -s "${BASE_URL}/api/playlist/${PLAYLIST}?refresh=true" > /dev/null

          if [ $? -eq 0 ]; then
            echo "  ‚úì $PLAYLIST refreshed"
          else
            echo "  ‚ö†Ô∏è $PLAYLIST refresh had issues (non-critical)"
          fi

          # Small delay to avoid rate limiting
          sleep 2
        done

        echo ""
        echo "‚úÖ All playlists refreshed with full v4v parsing"
        
        echo ""
        echo "‚ú® Playlist refresh workflow completed"
      env:
        BASE_URL: ${{ secrets.PLAYLIST_BASE_URL || 'https://stablekraft.app' }}

