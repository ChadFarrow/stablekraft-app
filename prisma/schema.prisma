generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ArtworkColor {
  id              String   @id @default(cuid())
  imageUrl        String   @unique
  originalColor   String
  enhancedColor   String
  backgroundColor String
  textColor       String
  isAppealing     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([imageUrl])
  @@index([createdAt])
  @@index([createdAt, isAppealing])
}

model Feed {
  id           String    @id
  guid         String?   @unique
  title        String
  description  String?
  originalUrl  String    @unique
  cdnUrl       String?
  type         String    @default("album")
  artist       String?
  image        String?
  language     String?
  category     String?
  explicit     Boolean   @default(false)
  priority     String    @default("normal")
  status       String    @default("active")
  lastFetched  DateTime?
  lastError    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  v4vRecipient String?
  v4vValue     Json?
  publisherId  String?
  Track        Track[]
  publisher    Feed?     @relation("PublisherAlbums", fields: [publisherId], references: [id])
  albums       Feed[]    @relation("PublisherAlbums")

  @@index([guid])
  @@index([lastFetched])
  @@index([status])
  @@index([status, lastFetched])
  @@index([status, priority])
  @@index([status, type])
  @@index([type])
  @@index([publisherId])
}

model PlaylistTrack {
  id           String       @id
  playlistId   String
  trackId      String
  position     Int
  addedBy      String?
  addedAt      DateTime     @default(now())
  UserPlaylist UserPlaylist @relation(fields: [playlistId], references: [id], onDelete: Cascade)

  @@unique([playlistId, trackId])
  @@index([playlistId, position])
}

model Track {
  id               String    @id
  guid             String?   @unique
  title            String
  subtitle         String?
  description      String?
  artist           String?
  album            String?
  audioUrl         String
  duration         Int?
  explicit         Boolean   @default(false)
  image            String?
  publishedAt      DateTime?
  itunesAuthor     String?
  itunesSummary    String?
  itunesImage      String?
  itunesDuration   String?
  itunesKeywords   String[]  @default([])
  itunesCategories String[]  @default([])
  v4vRecipient     String?
  v4vValue         Json?
  startTime        Float?
  endTime          Float?
  searchVector     String?
  feedId           String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  trackOrder       Int?
  status           String    @default("active")
  Feed             Feed      @relation(fields: [feedId], references: [id], onDelete: Cascade)
  systemPlaylists  SystemPlaylistTrack[]

  @@index([album])
  @@index([artist, album])
  @@index([artist])
  @@index([feedId])
  @@index([feedId, trackOrder])
  @@index([feedId, publishedAt])
  @@index([feedId, status])
  @@index([guid])
  @@index([guid, feedId])  // Composite index for playlist lookups
  @@index([guid, status])  // For active track filtering in playlists
  @@index([publishedAt])
  @@index([status])
  @@index([title])
  @@index([trackOrder])
}

model UserPlaylist {
  id            String          @id
  name          String
  description   String?
  isPublic      Boolean         @default(false)
  createdBy     String
  image         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  PlaylistTrack PlaylistTrack[]

  @@index([createdBy])
  @@index([isPublic])
}

model User {
  id              String         @id @default(cuid())
  nostrPubkey     String         @unique
  nostrNpub       String         @unique
  displayName     String?
  avatar          String?
  bio             String?
  lightningAddress String?
  relays          String[]       @default([])
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  favoriteTracks  FavoriteTrack[]
  favoriteAlbums FavoriteAlbum[]
  follows         Follow[]       @relation("Follower")
  followers       Follow[]       @relation("Following")
  posts           NostrPost[]
  boostEvents     BoostEvent[]

  @@index([nostrPubkey])
  @@index([nostrNpub])
  @@index([createdAt])
}

model Follow {
  id          String   @id @default(cuid())
  followerId String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@index([followerId, createdAt])
}

model NostrPost {
  id        String   @id @default(cuid())
  userId    String
  eventId   String   @unique
  kind      Int
  content   String
  trackId   String?
  feedId    String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventId])
  @@index([kind])
  @@index([trackId])
  @@index([feedId])
  @@index([userId, createdAt])
}

model BoostEvent {
  id          String   @id @default(cuid())
  userId      String
  trackId     String
  eventId     String   @unique
  amount      Int
  message     String?
  paymentHash String?
  relayUrls   String[] @default([])
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([trackId])
  @@index([eventId])
  @@index([userId, createdAt])
  @@index([trackId, createdAt])
}

model FavoriteTrack {
  id           String   @id @default(cuid())
  sessionId    String?
  userId       String?
  trackId      String
  nostrEventId String?  // ID of the Nostr event published to relays
  nip51Format  Boolean  @default(false)  // Whether published in NIP-51 format
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, trackId])
  @@unique([userId, trackId])
  @@index([sessionId])
  @@index([userId])
  @@index([trackId])
  @@index([nostrEventId])
  @@index([sessionId, createdAt])
  @@index([userId, createdAt])
}

model FavoriteAlbum {
  id           String   @id @default(cuid())
  sessionId    String?
  userId       String?
  feedId       String
  type         String   @default("album")  // 'album', 'publisher', or 'playlist' - determines which favorites tab it appears in
  nostrEventId String?  // ID of the Nostr event published to relays
  nip51Format  Boolean  @default(false)  // Whether published in NIP-51 format
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, feedId])
  @@unique([userId, feedId])
  @@index([sessionId])
  @@index([userId])
  @@index([feedId])
  @@index([nostrEventId])
  @@index([sessionId, createdAt])
  @@index([userId, createdAt])
}

// System playlists (MMM, HGH, SAS, etc.) - stored in DB for instant loading
model SystemPlaylist {
  id          String   @id  // "mmm", "hgh", "sas", "iam", "itdv", "b4ts", "mmt", "upbeats"
  title       String
  description String?
  artwork     String?
  link        String?
  updatedAt   DateTime @updatedAt

  tracks      SystemPlaylistTrack[]

  @@index([updatedAt])
}

model SystemPlaylistTrack {
  id         String   @id @default(cuid())
  playlistId String
  trackId    String
  position   Int
  episodeId  String?  // For episode grouping (MMM has episode markers)

  playlist   SystemPlaylist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  track      Track          @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([playlistId, trackId])
  @@index([playlistId, position])
  @@index([playlistId, episodeId])
}
